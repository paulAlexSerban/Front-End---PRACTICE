name: Continuous Integration

on:
  push:
    branches: ['develop', 'release', 'main']
  workflow_dispatch:

env:
  NODE_VERSION: 18.17.1
  SITE_URL: https://paulalexserban.github.io/prj--fe-ci-build-system

jobs:
  setup_job:
    runs-on: ubuntu-latest
    environment: 
      name: 'Build'
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - name: 'ðŸ“¥ checkout repository'
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: 'ðŸ”„  Cache node_modules'
        uses: actions/cache@v2
        with:
          path: ~/.npm
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

      - name: 'ðŸ”§ Setup NodeJS ${{ env.NODE_VERSION }}'
        uses: actions/setup-node@v1
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: 'ðŸ“¦  Install CI dependencies'
        run: npm install
      
      - name: Set matrix for next job
        id: set-matrix
        run: |
          echo "::set-output name=matrix::{\"include\": [{\"project\": \"ui-website-boilerplate\"},{\"project\": \"ui-app-boilerplate\"}]}"
  
  operate:
    needs: setup_job
    runs-on: ubuntu-latest
    environment:
      name: 'Build'
    strategy:
      matrix: ${{fromJson(needs.setup_job.outputs.matrix)}}
    steps:
      # @TODO: should check which sub project has changed and only then run the required operation
      - name: 'ðŸ§¹ Lint ${{ matrix.project }}'
        run: npm run lint --workspace ${{ matrix.project }}
      - name: 'ðŸ§ª Test ${{ matrix.project }}'
        run: npm run test --workspace ${{ matrix.project }}
      - name: 'ðŸš€ Build ${{ matrix.project }}'
        run: npm run build --workspace ${{ matrix.project }}
